#!/bin/bash

set -e
set -o pipefail

# Fetch the latest release from the upstream repository
RELEASES="$(curl -s https://api.github.com/repos/actions/runner-images/releases | jq -r '.[].tag_name' | grep ubuntu22)"

for release in $RELEASES ; do
  RELEASE_DATE="${release##*/}"
  RELEASE_DIST="${release%/*}"

  printf "\n## RELEASE_DIST=%s RELEASE_DATE=%s\n" "$RELEASE_DIST" "$RELEASE_DATE"

  if [[ "$RELEASE_DATE" < "202311" ]]; then
    echo "$RELEASE_DATE is a too old release. Not supported."
    exit 0
  fi

  for arch in x64 arm64 ; do
    release_dir="releases/$release-$arch"
    if [ -d "$release_dir" ]; then
      echo "Skipping $release_dir, already exists"
      continue
    else
      ./bin/pull "$release_dir"
      ./bin/patch "$release_dir"
      ./bin/build "$release_dir"

      if [ -n "$GITHUB_OUTPUT" ]; then
        echo "release=$release_dir" >> "$GITHUB_OUTPUT"
      fi
      # only perform one release per run, so that commits are clearer
      exit 0
    fi
  done
done
